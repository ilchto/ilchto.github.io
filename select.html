<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="static/css/semantic.min.css"  media="screen,projection"/>
    <link type="text/css" rel="stylesheet" href="static/css/swiper-bundle.min.css"/>
    <style>
      body {
        min-width: 360px;
        background: rgb(0 0 0 / 5%);
      }
      #topbar{
        height: 65px;
        border-bottom: 1px solid gray;
        min-width: 360px;
        margin: 0px;
        background: white;
      }
      #search {
        text-align: center;
      }
      #person_menu {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%,-50%);
      }
      #filter_row {
        margin: 0px;
        background: #343434;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
      }
      #content {
        margin: auto;
        margin-top: 65px;
        max-width: 600px;
        overflow: hidden;
        position: relative;
      }
      #toppanel {
        margin: 0px; position: absolute; left: 0px; top: 0px; width: 100%;
      }
      #bottom_footer {
        height: 400px;
        background: #1c1c1c;
      }
      .calDay {
        background: none;
        color: white;
      }
      .calDay.active {
        background: #00b5ad;
        color: white;
      }
      .calDay.active .calDayStatus {
        display: none;
      }
      .calDay.disabled {
        color: gray;
      }
      .bigCalendar {
        transition: height 0.3s;
      }
      .bigCalendar.dragging {
        transition: height 0.0s;
      }
      .mysticky {
        position: relative;
        /*z-index: 100;*/
      }
      #calendar {
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            background: #343434;
            color: white;
            padding: 1rem 0px;
      }
      .swiper-button-next {
        right: 0px;
      }
      .swiper-button-next:after {
        font-size: 26px;
        color: #00b5ad;
      }
      .swiper-button-prev {
        left: 0px;
      }
      .swiper-button-prev:after {
        font-size: 26px;
        color: #00b5ad;
      }
      #timelist {
        padding: 1rem;
        min-height: 100%;
        background: white;
      }
      .bigCal-scrollbar {
        position: absolute;
        height: 100%;
        width: 8px;
        right: 0px;
        top: 0px;
        background: rgb(0 0 0 / 10%);
        border-radius: 5px;
      }
      .bigCal-bar {
        position: absolute;
        width: 100%;
        background: gray;
        border-radius: 5px;
        left: 0px;
        top: 0px;
        height: 50px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="static/js/semantic.min.js"></script>
    <script type="text/javascript" src="static/js/reef.min.js"></script>
    <script type="text/javascript" src="static/js/swiper-bundle.min.js"></script>
    <script type="text/javascript" src="static/js/tools.js"></script>
    <div id="background-image" style="background-image: url(static/source/living-room.jpg); background-size: cover; background-position: center; position: absolute; height: 300px; width: 100%;">
      <div style="position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; background: rgba(0,0,0,0.2);"></div>
    </div>
    <div id="content">
      <div id="header"><h1 class="ui inverted header" style="margin-top: 20px; width: 100%; padding: 1rem; height: 150px;"></h1></div>
      <div id="filter_row"></div>
      <div class="mysticky"><div class="mystickyContent"><div id="calendar"></div></div></div>
      <div id="timelist"></div>
      <div id="bottom_footer"></div>
    </div>
    <div id="toppanel" style="z-index: 1000;">
      <div class="ui grid" id="topbar">
      <div class="three wide column"></div>
      <div class="ten wide column" id="search_col"></div>
      <div class="three wide column" id="person_col"></div>
    </div></div>


    <script type="text/javascript">
      let {store, component, render} = reef;
      let meta_data = {
        search_placeholder: {fi: "Etsi palveluita...", en: "Search services..."},
        profile: {
          login: {fi: "Kirjaudu tai rekisteröidy", en: "Login or register"},
          language: {fi: "Kieli", en: "Language"},
          language_select: {fi:"Suomi", en:"English"},
          customer_service: {fi: "Asiakaspalvelu", en: "Customer service"},
          orders: {fi: "Tilaukseni", en: "My orders"},
          account: {fi: "Tilini tiedot", en: "Account info"},
          logout: {fi: "Kirjaudu ulos", en: "Logout"}
        },
        city: {
          cities: ["Helsinki", "Espoo", "Tampere", "Turku", "Vantaa", "Järvenpää", "Kerava"],
          placeholder: {fi: "Valitse kaupunki", en: "Select a city"},
          search_placeholder: {fi:"Etsi kaupunkia...", en: "Search cities..."},
        },
        agent: {
          placeholder: {fi: "Haluan että minua palvelee", en: "I want to be served by"},
          menuheader: [{fi: "Valitse yksi", en: "Select one"},{fi: "Sinua jo palvelleet henkilöt", en: "People who have already served you"}],
          mainoption: {fi: "Kaikki", en: "All"},
          agents: [
            {id: "jormamatikainen", name: "Jorma Matikainen", text: {fi: "palveli sinua 3kk sitten", en: "served you 3 months ago"}, img: "face.png"},
            {id: "hannelehanhi", name: "Hannele Hanhi", text: {fi: "palveli sinua noin vuosi sitten", en: "served you about year ago"}, img: "face.png"}
          ]
        },
        calendar: {
          weekDays: {fi: ['M','T','K','T','P','L','S'], en: ['M','T','W','T','F','S','S']},
          weekDaysFull: {fi: ['Maanantai','Tiistai','Keskiviikko','Torstai','Perjantai','Lauantai','Sunnuntai'], en: ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday']},
          months: {
            fi: ['Tammikuu','Helmikuu','Maalis','Huhtikuu','Toukokuu','Kesäkuu','Heinäkuu','Elokuu','Syyskuu','Lokakuu','Marraskuu','Joulukuu'],
            en: ['January','February','March','April','May','June','July','August','September','October','November','December']
          },
          weekWords: {fi:['Tänään','Huomenna','Tämän viikon','Ensi viikon'],en:['Today','Tomorrow','This week','Next week']},
          wider: {fi: ["Laajenna","Supista"], en: ["Open","Close"]},
          timeButtons: [{fi: "Aamu", en: "Morning"},{fi: "Päivä", en: "Day"},{fi:"Iltapäivä",en:"Afternoon"},{fi:"Ilta",en:"Evening"}]
        },
        daysAvailable: {},
        dayTimes: []
      };
      let selected_language = "fi";
      let login = false;
      let selected_city = "Turku";
      let selected_agent = "all";
      let service = {header:{fi: "Kodin perussiivous", en: "Basic house cleaning"},img:"static/source/living-room.jpg"};

      //simulate daysAvailable
      let options = ["free","almost full","full"];
      let startDate = new Date();
      for(var i=0; i<100; i++) {
        let thisDate = startDate.addDays(i);
        let thisDateStr = formatDate(thisDate);
        meta_data.daysAvailable[thisDateStr] = options[Math.floor(Math.random() * options.length)];
      }
      let person_options = [
        ["face.png","Marika", Math.floor(Math.random()/2*10)],
        ["face1.png","Diana",Math.floor(Math.random()/2*10)],
        ["face2.png","Julia",Math.floor(Math.random()/2*10)],
        ["face3.png","Heidi",Math.floor(Math.random()/2*10)],
        ["face4.png","Matias",Math.floor(Math.random()/2*10)],
        ["face5.png","Simon",Math.floor(Math.random()/2*10)],
        ["face6.png","Jane",Math.floor(Math.random()/2*10)]
      ];
      let price_options = [24.5,29.9,32,34.9];
      let times = [7,8,9,10,11,12,13,14,15,16,17,18,19];
      let tags = [{fi: "Tilastit viimeksi 3kk sitten", en: "last served you 3 months ago"},{fi: "uusi henkilö", en: "a new person"}]

      times.forEach((time, i) => {
        let person = person_options[Math.floor(Math.random() * person_options.length)];
        let price = price_options[Math.floor(Math.random() * price_options.length)];
        let rating = person[2];
        let tags_ = [];
        if(Math.random()>0.7) {
          tags_.push(tags[Math.floor(Math.random() * tags.length)]);
        } else if(Math.random()>0.5) {
          tags_.push(tags[0]);
          tags_.push(tags[1]);
        }
        let data = {time: time, face: person[0], name: person[1], price: price, rating: rating, tags: tags_};
        meta_data.dayTimes.push(data);
      });


      create_searchaction ();
      create_personmenu ();
      create_filters ();
      create_calendar ();
      showTimelist(formatDate(new Date()));
      fitBackgroundImg ();

      function create_searchaction () {
        render(
          '#search_col',
          `<div class="ui small search" id="search">
            <div class="ui icon input">
              <input class="prompt" type="text" placeholder="${meta_data.search_placeholder[selected_language]}">
              <i class="search icon"></i>
            </div>
            <div class="results"></div>
          </div>`
        );

        let categoryContent = [
          { category: 'South America', title: 'Brazil' },
          { category: 'South America', title: 'Peru' },
          { category: 'North America', title: 'Canada' },
          { category: 'Asia', title: 'South Korea' },
          { category: 'Asia', title: 'Japan' },
          { category: 'Asia', title: 'China' },
          { category: 'Europe', title: 'Denmark' },
          { category: 'Europe', title: 'England' },
          { category: 'Europe', title: 'France' },
          { category: 'Europe', title: 'Germany' },
          { category: 'Africa', title: 'Ethiopia' },
          { category: 'Africa', title: 'Nigeria' },
          { category: 'Africa', title: 'Zimbabwe' },
        ];

        $('#search').search({type:'category', source: categoryContent, onSelect: function (e) {
          console.log(e);
        }});
      }
      function create_personmenu () {
        render(
          '#person_col',
          `<div id="person_menu" class="ui top right pointing dropdown">
            <i class="teal large user icon"></i>
            <div class="menu">
              <div id="startlogin" class="item active"><i class="teal sign-in icon"></i>${meta_data.profile.login[selected_language]}</div>
              <div class="item"><i class="language icon"></i>${meta_data.profile.language[selected_language]}: ${meta_data.profile.language_select[selected_language]}
                <div class="menu left">
                  <div class="item">Suomi</div>
                  <div class="item">English</div>
                </div>
              </div>
              <div id="startcusserv" class="item"><i class="comments icon"></i>${meta_data.profile.customer_service[selected_language]}</div>
            </div>
          </div>`
        );

        $('#person_menu').dropdown({
          transition: 'drop',
          action: 'hide',
          onChange: function (e, e2, t) {
            for(var k in meta_data.profile.language_select) {
              let v = meta_data.profile.language_select[k];
              if (v.toLowerCase() == e) {
                selected_language = k;
                // preloader
                setTimeout(function () {
                  create_personmenu();
                  create_searchaction();
                  create_filters();
                }, 500);
              }
            }
            if (t[0].getAttribute("id") == "startlogin") {
              console.log("Käynnistä login");
            } else if (t[0].getAttribute("id") == "startcusserv") {
              console.log("Käynnistä asiakaspalvelu");
            }
          }
        });
      }
      function create_filters () {
        document.querySelector("#header .header").innerHTML = service.header[selected_language];
        document.querySelector("#background-image").style.backgroundImage = "url("+service.img+")";
        let cities = '';
        let default_city = meta_data.city.placeholder[selected_language];
        meta_data.city.cities.forEach((city) => {
          let active_ = '';
          if (selected_city == city) {
            default_city = selected_city;
            active_ = ' active selected';
          }
          let div_ = `<div class="item${active_}">${city}</div>`;
          cities = cities+div_;
        });

        let agents = '';
        let default_agent = meta_data.agent.placeholder[selected_language];
        meta_data.agent.agents.forEach((agent, i) => {
          let div_ = `<div data-id="${agent.id}" class="item">
            <img class="ui avatar image" src="static/source/${agent.img}">
            <span>${agent.name}</span>
          </div>`;
          agents = agents+div_;
        });

        let displayNone = '';
        if(meta_data.agent.agents.length == 0) {
          displayNone = 'style="display: none;"';
        }

        render('#filter_row', "");

        render(
          '#filter_row',
          `
            <div class="ui grid" style="margin: 0px;">
              <div class="six wide column">
                <div id="cityselector" class="ui mini dropdown labeled icon inverted button">
                  <i class="world icon"></i>
                  <span class="text">${default_city}</span>
                  <div class="menu">
                  <div class="ui icon search input">
                    <i class="search icon"></i>
                    <input type="text" placeholder="${meta_data.city.search_placeholder[selected_language]}">
                  </div>
                  <div class="divider"></div>
                    ${cities}
                  </div>
                </div>
              </div>
              <div class="ten wide column" ${displayNone}>
                <div style="float: right;" id="agentselector" class="ui mini labeled icon inverted dropdown button">
                  <i class="add user icon"></i>
                  <span class="text"><img class="ui avatar image" src="static/source/face.png">
                      ${meta_data.agent.mainoption[selected_language]}</span>
                  <div class="left menu" style="min-width: 200px;">
                    <div class="header">
                      ${meta_data.agent.menuheader[0][selected_language]}
                    </div>
                    <div data-id="all" class="item">
                      <img class="ui avatar image" src="static/source/face.png">
                      ${meta_data.agent.mainoption[selected_language]}
                    </div>
                    <div class="header">
                      ${meta_data.agent.menuheader[1][selected_language]}
                    </div>
                    ${agents}
                  </div>
                </div>
              </div>
            </div>
          `
        );

        $('#cityselector').dropdown({
          onChange: function (e,e2,t) {
            selected_city = t[0].innerHTML;
            console.log(selected_city);
            console.log("NYT PITÄÄ UPDATAA myös palvelija vaihtoehdot");
          }
        });

        $('#agentselector').dropdown({
          onChange: function (e,e2,t) {
            selected_agent = t[0].getAttribute("data-id");
            console.log(selected_agent);
          }
        });
      }
      function create_calendar () {
        let target = document.getElementById("calendar");
        let cal_weeks = '';
        let thisDate = new Date();
        let activeDateStr = formatDate(thisDate);
        let thisWeekNum = ISO8601_week_no(thisDate);
        let thisWeekFirstDate = getDateOfISOWeek(thisWeekNum, thisDate.getFullYear());
        let weekDays = '';
        let prosByseven = 100/7;
        let currentWeekFirstDate = thisWeekFirstDate;
        let thisMonthFirstDate = new Date(thisDate.getFullYear(), thisDate.getMonth(), 1);
        let lastDate = thisWeekFirstDate.addDays(53*7);
        let monthElms = '';
        let selectedDayIndex = thisDate.getISODay()-1;
        let bigCalActiveIndex = 0;
        meta_data.calendar.weekDays[selected_language].forEach((d, i) => {
          let sundayColor = '';
          if (i==6) {
            sundayColor = ' color: #00b5ad;';
          }
          let weekDay = `<div style="width: ${prosByseven}%; display: inline-block; text-align: center;${sundayColor}">${d}</div>`;
          weekDays = weekDays+weekDay;
        });
        let dayIndex = selectedDayIndex;
        for (let i=0; i<13; i++) {
          let currentMonthFirstDate = new Date(thisMonthFirstDate);
          currentMonthFirstDate = new Date(currentMonthFirstDate.setMonth(currentMonthFirstDate.getMonth()+i));
          let daysInMonth = getDaysInMonth(currentMonthFirstDate.getFullYear(), currentMonthFirstDate.getMonth()+1);
          let currentMonthFirstDay = currentMonthFirstDate.getISODay();
          let weeks = [];
          let currentDayIndex = 0;
          let currentWeekIndex = 0;
          let currentMonthIndex = 0;
          let thisMonthText = meta_data['calendar']['months'][selected_language][currentMonthFirstDate.getMonth()];
          let thisYear = currentMonthFirstDate.getFullYear();
          for (let i2=0; i2<(daysInMonth+currentMonthFirstDay-1); i2++) {
            if(currentWeekIndex == 7) {
              currentWeekIndex = 0;
            }
            if(currentWeekIndex == 0) {
              weeks.push([]);
              currentMonthIndex++;
            }
            if(currentMonthFirstDay<=currentDayIndex+1) {
              let day = currentDayIndex-currentMonthFirstDay+2;
              let currentDate = new Date(thisYear,currentMonthFirstDate.getMonth(),day)
              let currentDateText = formatDate(currentDate);
              let thisType = "date"
              if (currentDate <= thisDate.addDays(-1) || currentDate > lastDate) {
                thisType = "disabled";
              }
              weeks[currentMonthIndex-1].push({dayNo: day, type:thisType, date: currentDateText});
            } else {
              weeks[currentMonthIndex-1].push({dayNo: "", type:"empty", date: null});
            }
            currentWeekIndex++;
            currentDayIndex++;
          }
          let weekElms = '';
          weeks.forEach((week) => {
            let dayElms = '';
            week.forEach((day) => {
              let width = 100/7;
              let thisClass = "normal";
              let dateStr = '';
              let dayIndex_ = '';
              let pointer = '';
              if(day.type=="disabled" || day.type == "empty") {
                thisClass = "disabled";
              } else {
                dayIndex_ = 'data-dayindex="'+dayIndex+'" ';
                pointer = ' cursor: pointer;';
                dayIndex++;
              }
              if(day.date) {
                dateStr = `data-datestr="${day.date}" `;
              }
              dayElm = `<div style="width: ${width}%; position: relative; display: inline-block; padding-top: 15px;">
                <div ${dayIndex_}${dateStr}class="calDay ${thisClass}" style="width: 30px;height: 30px;border-radius: 50%;margin: auto; position: relative;">
                  <div class="caldayDay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);${pointer}">${day.dayNo}</div>
                  <div class="calDayStatus" style="position: absolute;top: 0px;left: 50%;transform: translateX(-50%);width: 5px;height: 5px;border-radius: 50%;"></div>
                </div>
              </div>`;
              dayElms = dayElms+dayElm;
            });
            let weekElm = `<div style="height: auto; scroll-snap-align: start;">${dayElms}</div>`;
            weekElms = weekElms+weekElm;
          });
          let monthElm = `<div class="ui small header" style="height: auto;padding: 1rem 2rem 0rem;margin: 0px;scroll-snap-align: start;color: white;border-top: 1px solid rgba(255,255,255,.15);margin-top: 1rem;">${thisMonthText} ${thisYear}</div>${weekElms}`;
          monthElms = monthElms+monthElm;
          //console.log(monthElm);
        }

        render(
          target,
          `
          <div style="width: 100%; height: 20px; margin-bottom: 1rem;">
          ${weekDays}
          </div>
          <div class="swiper" id="week_swiper" style="height: 50px;">
            <div class="swiper-wrapper">
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
          </div>
          <div class="bigCalendar" style="height: 50px; display: none; position: relative; overflow: hidden;">
            <div class="bigCal-rows hiddenScrollbar" style="overflow: auto; scroll-snap-type: y mandatory; position: relative; height: 100%;">
              ${monthElms}
            </div>
            <div class="bigCal-scrollbar"><div class="bigCal-bar"></div></div>
          </div>
          <div class="calWider close" style="height: 24px;position: relative;margin-top: 10px;padding: 10px 0px;cursor: pointer;">
            <div class="ui tiny horizontal divider inverted header" style="pointer-events:none;">${meta_data.calendar.wider[selected_language][0]}</div>
          </div>`
        );

        if(isMobile()) {
          target.querySelector('.swiper-button-next').style.display = "none";
          target.querySelector('.swiper-button-prev').style.display = "none";
        }

        let weekSwiper = new Swiper('#week_swiper',{
          slidesPerView: 7,
          slidesPerGroup: 7,
          navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
          },
          virtual: {
            slides: (function () {
              const slides = [];
              for (var i = 0; i < (53*7); i++) {
                let date = thisWeekFirstDate.addDays(i);
                let day = date.getDate();
                let monthNum = date.getMonth();
                let month = meta_data.calendar.months[selected_language][monthNum];
                let year = date.getFullYear();
                let dateStr = formatDate(date);
                let divStyle = 'cursor: pointer;';
                let dayClass = 'calDay normal';
                if (date<thisDate) {
                  if(day!=thisDate.getDate()) {
                    divStyle = '';
                    dayClass = 'calDay disabled';
                  }
                }
                if (day==thisDate.getDate() && monthNum == thisDate.getMonth() && year == thisDate.getFullYear()) {
                  dayClass = 'calDay active';
                  divStyle = 'color: white;';
                }
                if(day == 1) {
                  day = '1/'+(monthNum+1);
                }
                let dayElm = `<div style="${divStyle}"><div style="height: 15px;position: relative;"><div style="height: 5px;width: 5px;border-radius: 50%;position: absolute;transform: translateX(-50%);left: 50%;bottom:-6px;"></div></div><div style="text-align: center;"><div style="text-align: center;position: relative;"><div data-datestr="${dateStr}" class="${dayClass}" style="width: 30px;height: 30px;border-radius: 50%;margin: auto;"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%)">${day}</div></div></div></div></div>`
                slides.push(dayElm);
              }
              return slides;
            })(),
          },
        });

        Array.from(document.querySelectorAll('.bigCalendar .calDay .caldayDay')).forEach((day, i) => {
          day.addEventListener("click", function (e) {
            console.log("toimiiko?")
            let target = e.target.parentNode;
            if (target.className == "calDay normal") {
              if (document.querySelector('.bigCalendar .calDay.active')) {
                document.querySelector('.bigCalendar .calDay.active').className = "calDay normal";
              }
              target.className = "calDay active";
              let clickedIndex = Number(target.getAttribute("data-dayindex"));
              selectDay(target.getAttribute("data-datestr"), clickedIndex, false);
              wider.click();
            }
          });
        });

        weekSwiper.on("click", function (e) {
          let slide = e.clickedSlide.querySelector(".calDay");

          if (slide.className == "calDay normal") {
            if (document.querySelector('#week_swiper .calDay.active')) {
              document.querySelectorAll('#week_swiper .calDay.active').forEach((calDayActive) => {
                calDayActive.className = "calDay normal";
              });
            }
            selectDay(slide.getAttribute("data-datestr"), e.clickedIndex, true);
            slide.className = "calDay active";
          };
          days_available_weekCal ();
        });
        weekSwiper.on('transitionEnd', function() {
          currentWeekFirstDate = thisWeekFirstDate.addDays(weekSwiper.activeIndex);
          activateDayInBigCalendar(formatDate(currentWeekFirstDate), 0, "week");
          days_available_weekCal ();
        });

        activateDayInBigCalendar(activeDateStr, 0, "day");

        function selectDay (activeDateStr, clickedIndex, updateBigCal) {
          if (updateBigCal) {
            activateDayInBigCalendar(activeDateStr, 0, "day");
          }
          weekSwiper.virtual.cache = [];
          weekSwiper.virtual.slides[selectedDayIndex] = weekSwiper.virtual.slides[selectedDayIndex].replace("calDay active","calDay normal");
          weekSwiper.virtual.slides[clickedIndex] = weekSwiper.virtual.slides[clickedIndex].replace("calDay normal","calDay active");
          //console.log(weekSwiper.virtual.cache);
          weekSwiper.virtual.update(true);
          selectedDayIndex = clickedIndex;
          if(!updateBigCal) {
            closeCal();
          }
          showTimelist(activeDateStr);
        }
        function activateDayInBigCalendar(datestr, speed, option) {
          let bigCalDiv = document.querySelector(".bigCalendar");
          let thisSlideDay = findDivInBigCalendar(datestr);
          console.log(thisSlideDay);
          let thisWeekDiv = thisSlideDay.parentElement.parentElement;
          let slideIndex = getChildElementIndex(thisWeekDiv);
          if(option == "day") {
            let activeDay = bigCalDiv.querySelector(".calDay.active");
            if(activeDay) {
              activeDay.className = "calDay normal";
            }
            thisSlideDay.className = "calDay active";
          }
          thisWeekDiv.parentElement.scrollTop = thisWeekDiv.offsetTop;
        }
        function findDivInBigCalendar (dateStr) {
          let dayDiv = document.querySelector('.bigCalendar [data-datestr="'+dateStr+'"]');
          if (dayDiv == null) {
            dayDiv = document.querySelector('.bigCalendar [data-datestr]');
          }
          console.log(dayDiv);
          return dayDiv;
        }

        let wider = target.querySelector(".calWider");
        let bigCal = target.querySelector(".bigCalendar");
        let maxHeight = 300;
        let minHeight = 50;
        let startHeight;
        let clickOpen = false;
        let clickOpenDrag = false;
        let allowMouse = true;
        let startState = "close";
        let startY;
        wider.addEventListener("touchstart",openCaldragStart);
        wider.addEventListener("mousedown",openCaldragStart);

        function openCaldragStart (e) {
          if(e.type=="touchstart" || allowMouse) {
            window.addEventListener("touchmove", openCaldrag, {passive: false});
            window.addEventListener("mousemove", openCaldrag);
            window.addEventListener("touchend", openCaldragEnd);
            window.addEventListener("mouseup", openCaldragEnd);
            target.querySelector(".swiper").style.display = "none";
            bigCal.style.display = "";
            bigCal.classList.add("dragging");
            hideScrollbar ();
            startHeight = bigCal.getBoundingClientRect().height;
            clickOpen = true;
            clickOpenDrag = false;
            setTimeout(function () {
              clickOpen = false
              clickOpenDrag = true;
            }, 400);
            if(wider.className == "calWider close") {
              activateDayInBigCalendar(formatDate(currentWeekFirstDate), 0, "week");
              startState = "close";
            } else {
              startState = "open";
            }
          }
          if(e.type == "touchstart") {
            allowMouse = false;
            startY = e.touches[0].clientY;
          } else {
            startY = e.clientY;
          }
        }
        function openCaldrag (e) {
          let y;
          if(e.type == "touchmove") {
            y = e.touches[0].clientY;
          } else {
            y = e.clientY;
          }
          let y_ = y-startY;
          let thisHeight = Math.max(minHeight,Math.min(maxHeight, (y_+startHeight)));
          bigCal.style.height = thisHeight+"px";
          if(clickOpenDrag) {
            if(startState == "close") {
              if(y_>50) {
                clickOpen = true;
              } else {
                clickOpen = false;
              }
            } else {
              if(y_<-50) {
                clickOpen = true;
              } else {
                clickOpen = false;
              }
            }
          }
          document.querySelector(".mysticky").style.height = document.querySelector("#calendar").getBoundingClientRect().height+"px";
          e.preventDefault();
          e.stopImmediatePropagation();
        }
        function openCaldragEnd (e) {
          bigCal.classList.remove("dragging");
          window.removeEventListener("touchmove", openCaldrag);
          window.removeEventListener("mousemove", openCaldrag);
          window.removeEventListener("touchend", openCaldragEnd);
          window.removeEventListener("mouseup", openCaldragEnd);
          if (clickOpen) {
            if(wider.className == "calWider close") {
              openCal();
            } else {
              closeCal();
            }
          } else {
            if(wider.className == "calWider close") {
              closeCal();
            } else {
              openCal();
            }
          }

        }
        function openCal() {
          wider.querySelector(".header").innerHTML = meta_data.calendar.wider[selected_language][1];
          wider.className = "calWider open";
          setTimeout(function (){
            bigCal.style.height = maxHeight+"px";
          }, 1);
          let anim = setInterval(modifyScrollBar, 17);
          let stickyModify = setInterval(function () {
            document.querySelector(".mysticky").style.height = document.querySelector("#calendar").getBoundingClientRect().height+"px";
          }, 17);
          setTimeout(function () {
            clearTimeout(anim);
            clearTimeout(stickyModify);
          },300);
        }
        function closeCal() {
          bigCal.style.height = minHeight+"px";
          wider.querySelector(".header").innerHTML = meta_data.calendar.wider[selected_language][0];
          let stickyModify = setInterval(function () {
            document.querySelector(".mysticky").style.height = document.querySelector("#calendar").getBoundingClientRect().height+"px";
          }, 17);
          setTimeout(function () {
            target.querySelector(".swiper").style.display = "";
            bigCal.style.display = "none";
            setTimeout(function () {
              weekSwiper.slideTo(selectedDayIndex,300);
            }, 50);
            clearTimeout(stickyModify);
          }, 300);
          wider.className = "calWider close";
          days_available_weekCal ();
        }

        let scrollBar = target.querySelector(".bigCal-bar");
        let scrollBarRail = scrollBar.parentElement;
        let bigCalRows = bigCal.querySelector('.bigCal-rows');
        let modifyScrollBarDisabled = false;
        let startTop;
        let maxTop;
        let hRows = 0;
        bigCalRows.addEventListener("scroll", modifyScrollBar);
        scrollBar.addEventListener("touchstart",scrollBardragStart);
        scrollBar.addEventListener("mousedown",scrollBardragStart);
        dragToScroll(bigCalRows);
        function modifyScrollBar () {
          if(!modifyScrollBarDisabled) {
            let hView = bigCal.getBoundingClientRect().height;
            let hRows = 0;
            Array.from(bigCalRows.children).forEach((elm) => {
              hRows += elm.getBoundingClientRect().height;
            });
            let h = Math.max(hView/hRows, 25);
            let topView = bigCalRows.scrollTop;
            let scrollPos = topView/(hRows-hView);
            scrollBar.style.height = h+"px";
            scrollBar.style.top = ((hView-h)*scrollPos)+"px";
          }
        }
        function scrollBardragStart (e) {
          window.addEventListener("touchmove", scrollBardrag, {passive: false});
          window.addEventListener("mousemove", scrollBardrag);
          window.addEventListener("touchend", scrollBardragEnd);
          window.addEventListener("mouseup", scrollBardragEnd);
          modifyScrollBarDisabled = true;
          startTop = e.target.offsetTop;
          maxTop = e.target.parentElement.getBoundingClientRect().height-e.target.getBoundingClientRect().height;
          if(e.type == "touchstart") {
            allowMouse = false;
            startY = e.touches[0].clientY;
          } else {
            startY = e.clientY;
          }
          hRows = 0;
          Array.from(bigCalRows.children).forEach((elm) => {
            hRows += elm.getBoundingClientRect().height;
          });
        }
        function scrollBardrag (e) {
          let y;
          if(e.type == "touchmove") {
            y = e.touches[0].clientY;
          } else {
            y = e.clientY;
          }
          let y_ = Math.min(Math.max(startTop+(y-startY),0),maxTop);
          scrollBar.style.top = y_+"px";
          bigCalRows.scrollTop = y_/maxTop*hRows;
          e.preventDefault();
          e.stopImmediatePropagation();
        }
        function scrollBardragEnd (e) {
          window.removeEventListener("touchmove", scrollBardrag, {passive: false});
          window.removeEventListener("mousemove", scrollBardrag);
          window.removeEventListener("touchend", scrollBardragEnd);
          window.removeEventListener("mouseup", scrollBardragEnd);
          modifyScrollBarDisabled = false;
        }
        days_available_bigCal ();
        days_available_weekCal ();
      }
      function days_available_bigCal () {
        for(dateStr in meta_data.daysAvailable) {
          let status = meta_data.daysAvailable[dateStr];
          let dayDiv = document.querySelector('.bigCalendar [data-datestr="'+dateStr+'"] .calDayStatus');
          if(status == "free") {
            dayDiv.style.background = "lightseagreen";
          } else if(status == "almost full") {
            dayDiv.style.background = "orange";
          } else {

            dayDiv.style.background = "black";
            dayDiv.parentElement.className = "calDay disabled";
          }
        }
      }
      function days_available_weekCal () {
        for(dateStr in meta_data.daysAvailable) {
          let status = meta_data.daysAvailable[dateStr];
          if(document.querySelector('#week_swiper [data-datestr="'+dateStr+'"]')) {
            let dayDiv = document.querySelector('#week_swiper [data-datestr="'+dateStr+'"]').parentElement.parentElement.previousElementSibling.lastChild;
            if(status == "free") {
              dayDiv.style.background = "lightseagreen";
            } else if(status == "almost full") {
              dayDiv.style.background = "orange";
            } else {
              dayDiv.style.background = "black";
              dayDiv.parentElement.parentElement.querySelector(".calDay").className = "calDay disabled";
            }
          }
        }
      }

      function showTimelist (date) {
        console.log("open timelist", date);
        let today = new Date(formatDate(new Date()));
        let thisDate = new Date(date);
        let monthStr = meta_data.calendar.months[selected_language][thisDate.getMonth()];
        let weekDayStr = meta_data.calendar.weekDaysFull[selected_language][thisDate.getISODay()-1];
        let fullYear = thisDate.getFullYear();
        let thisWeekNum = ISO8601_week_no(thisDate);
        let diffTime = Math.abs(thisDate - today);
        let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        let diffWeek = thisWeekNum - ISO8601_week_no(today);
        let dayStr = '';
        if(diffDays == 0) {
          dayStr = meta_data.calendar.weekWords[selected_language][0];
        } else if(diffDays == 1) {
          dayStr = meta_data.calendar.weekWords[selected_language][1];
        } else if(diffWeek == 0) {
          dayStr = meta_data.calendar.weekWords[selected_language][2]+" "+weekDayStr;
        } else if(diffWeek == 1) {
          dayStr = meta_data.calendar.weekWords[selected_language][3]+" "+weekDayStr;
        } else {
          dayStr = weekDayStr+" "+thisDate.getDate()+" "+monthStr+" "+fullYear;
        }
        //console.log(thisDate.getDate(), monthStr, weekDayStr, fullYear, thisWeekNum, " eroja päivissä: ", diffDays, " eroja viikoissa: ", diffWeek);

        let cardsHeight = ''
        if(document.querySelector('#timelist .ui.cards')) {
          cardsHeight = "height: "+document.querySelector('#timelist .ui.cards').getBoundingClientRect().height+"px;";
        }

        render('#timelist', '');
        render('#timelist',
        `<h2 class="ui header" style="margin-top: 2rem;">${dayStr}</h2>
        <div class="ui small basic buttons" style="visibility: hidden;">
          <button class="ui button" data-timestart="7" data-timeend="9">${meta_data.calendar.timeButtons[0][selected_language]}</button>
          <button class="ui button" data-timestart="10" data-timeend="14">${meta_data.calendar.timeButtons[1][selected_language]}</button>
          <button class="ui button" data-timestart="15" data-timeend="17">${meta_data.calendar.timeButtons[2][selected_language]}</button>
          <button class="ui button" data-timestart="18" data-timeend="22">${meta_data.calendar.timeButtons[3][selected_language]}</button>
        </div>
        <div class="timelist" style="margin: 2rem 0rem;">
          <div class="ui active centered inline loader" style="${cardsHeight}"></div>
          <div class="ui one cards" style="display: none;"></div>
        </div>
        `);

        setTimeout(function () {

          let listHTML = '';
          meta_data.dayTimes.forEach((time, i) => {
            let price = new Intl.NumberFormat('fi-FI', { style: 'currency', currency: 'EUR' }).format(time.price)+"/h";
            let timeStr = time.time+":00";
            let itemHTML = `
            <div class="ui card" style="position: inherit;" data-id="${i}" data-time="${time.time}">
              <div class="content">
                <div class="left floated header">
                  ${timeStr}
                </div>
                <div class="right floated header">
                  ${price}
                </div>
                <div class="description">
                  Elliot requested permission to view your contact details
                </div>
              </div>
              <div class="extra content">
                <div class="left floated extra">
                  Rating:
                  <div class="ui rating" data-rating="${time.rating}"></div>
                </div>
                <div class="right floated author">
                  <img class="ui avatar image" src="static/source/${time.face}" style="position: inherit;"> ${time.name}
                </div>
              </div>
            </div>`;
            listHTML += itemHTML;
          });


          render('#timelist .timelist',
          `<div class="ui active centered inline loader" style="display: none;"></div>
          <div class="ui one cards" style="overflow: hidden;">${listHTML}</div>
          `);

          $('#timelist .rating').rating('disable');

          let alltimes = [];
          document.querySelectorAll("#timelist .ui.card").forEach((card) => {
            alltimes.push(Number(card.getAttribute("data-time")));
          });
          alltimes = [...new Set(alltimes)];


          document.querySelectorAll('#timelist .ui.link.card').forEach((card, i) => {
            card.addEventListener("click", function (e) {
            });
          });
          document.querySelectorAll("#timelist .ui.basic.buttons .button").forEach((timebutton) => {
            let timestart = timebutton.getAttribute("data-timestart");
            let timeend = timebutton.getAttribute("data-timeend");

            let between = alltimes.filter(function(item) {
              return (item >= timestart && item <= timeend);
            });

            if(between.length == 0) {
              timebutton.style.display = "none";
            }

            timebutton.addEventListener("click", function (e) {
              if(e.target.classList.contains("active")) {
                e.target.classList.remove("active");
                document.querySelectorAll("#timelist .ui.card").forEach((card) => {
                  card.style.display = "";
                });
              } else {
                document.querySelectorAll("#timelist .ui.basic.buttons .button").forEach((item) => {
                  item.classList.remove("active");
                });
                e.target.classList.add("active");
                document.querySelectorAll("#timelist .ui.card").forEach((card) => {
                  if(card.getAttribute("data-time")>=timestart && card.getAttribute("data-time")<=timeend) {
                    card.style.display = "";
                  } else {
                    card.style.display = "none";
                  }
                });
              }
            })
          });
          document.querySelector("#timelist .ui.basic.buttons").style.visibility = "visible";

        }, 300);
      }

      function sticky_func () {
        let stickies = document.querySelectorAll(".mysticky");
        stickies.forEach((elm, i) => {
          let target = elm.querySelector(".mystickyContent");
          let offsetTop = 0;
          if(elm.getBoundingClientRect().top <= 0) {
            target.style.position = "fixed";
            target.style.top = offsetTop;
            target.style.width = elm.getBoundingClientRect().width;
            elm.style.height = target.getBoundingClientRect().height;
          } else {
            target.style.position = "";
            target.style.top = "";
            target.style.width = "";
            elm.style.height = "";
          }
        });
      }
      function hideScrollbar () {
        document.querySelectorAll(".hiddenScrollbar").forEach((elm) => {
          w = elm.parentElement.getBoundingClientRect().width;
          elm.style.width = (w+10)+"px";
        });

      }
      function fitBackgroundImg () {
        console.log(window.innerWidth);
        let background = document.querySelector("#background-image");
        if(window.innerWidth <= 620) {
          background.style.height = "175px";
        } else if (window.innerWidth <= 1000) {
          background.style.height = "300px";
        } else {
          background.style.height = "100%";
        }
      }
      window.addEventListener("scroll", function (e) {
        sticky_func ();
      });
      window.addEventListener("resize", function (e) {
        sticky_func ();
        hideScrollbar ();
        fitBackgroundImg ();
      });


    </script>
  </body>
<html>
